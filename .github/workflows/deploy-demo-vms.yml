# Deploy to Demo VMs - GitHub Actions Workflow
# 
# This workflow automatically deploys Aurora to demo VMs when code is pushed to the demo branch.
#
# üîß SETUP FOR YOUR PROJECT:
#
# 1. Update the `env` section below with your GCP infrastructure details:
#    - GCP_PROJECT: Your GCP project ID
#    - WORKLOAD_IDENTITY_PROVIDER: Full path to your WIF provider
#      (Format: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID)
#    - SERVICE_ACCOUNT: Email of your deployment service account
#
# 2. Create GCP secrets for VM configuration:
#    gcloud secrets create demo-gcp-zone --data-file=- <<< "us-central1-a"
#    gcloud secrets create demo-vm2-name --data-file=- <<< "aurora-demo-vm-2"
#
# 3. Grant the service account access to these secrets:
#    gcloud secrets add-iam-policy-binding demo-gcp-zone \
#      --member="serviceAccount:YOUR-SERVICE-ACCOUNT" \
#      --role="roles/secretmanager.secretAccessor"
#    gcloud secrets add-iam-policy-binding demo-vm2-name \
#      --member="serviceAccount:YOUR-SERVICE-ACCOUNT" \
#      --role="roles/secretmanager.secretAccessor"
#
# 4. Ensure your VMs have:
#    - Git repository cloned to /opt/aurora-demo
#    - Docker & Docker Compose installed
#    - SSH access from GitHub Actions (via WIF service account)
#
# For full setup instructions, see: docs/deployment/demo-vm-cicd.md
#

name: Deploy to Demo VMs

on:
  push:
    branches:
      - demo
  workflow_dispatch:

# ‚ö†Ô∏è  CHANGE THESE to match your GCP Workload Identity setup
# These are infrastructure values (not sensitive secrets)
env:
  # Your GCP project ID where secrets are stored
  GCP_PROJECT: sublime-flux-414616
  
  # Workload Identity Federation provider path
  # Format: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID
  WORKLOAD_IDENTITY_PROVIDER: projects/1015371839961/locations/global/workloadIdentityPools/github-actions/providers/github
  
  # Service account email for deployments
  SERVICE_ACCOUNT: aurora-demo-deployer@sublime-flux-414616.iam.gserviceaccount.com

jobs:
  deploy:
    name: Deploy to Demo VMs
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Load deployment configuration from GCP Secret Manager
        id: secrets
        run: |
          echo "Loading deployment configuration from GCP Secret Manager..."
          
          # Fetch deployment configuration (private secrets)
          GCP_ZONE=$(gcloud secrets versions access latest --secret="demo-gcp-zone" --project="${{ env.GCP_PROJECT }}")
          VM2_NAME=$(gcloud secrets versions access latest --secret="demo-vm2-name" --project="${{ env.GCP_PROJECT }}")
          
          # Export as environment variables
          echo "GCP_ZONE=$GCP_ZONE" >> $GITHUB_ENV
          echo "VM2_NAME=$VM2_NAME" >> $GITHUB_ENV
          
          echo "‚úÖ Deployment configuration loaded"

      # Commented out - only deploying to VM-2 for now
      # - name: Deploy to VM-1 (aurora-demo-vm)
      #   run: |
      #     echo "üöÄ Deploying to aurora-demo-vm..."
      #     gcloud compute ssh $VM1_NAME --zone=$GCP_ZONE --command="
      #       set -e
      #       echo 'üìÇ Navigating to project directory...'
      #       cd /opt/aurora-demo
      #       
      #       echo 'üì• Pulling latest code from demo branch...'
      #       git fetch origin
      #       git checkout demo
      #       git pull origin demo
      #       
      #       echo 'üîÑ Restarting services...'
      #       docker compose -f docker-compose.prod-local.yml up -d --remove-orphans
      #       
      #       echo '‚úÖ VM-1 deployment complete!'
      #     " 2>&1

      # - name: Wait for VM-1 services to stabilize
      #   run: |
      #     echo "‚è≥ Waiting 30 seconds for services to start..."
      #     sleep 30

      # - name: Health check VM-1
      #   run: |
      #     echo "üè• Checking VM-1 health..."
      #     
      #     VM1_IP=$(gcloud compute instances describe $VM1_NAME --zone=$GCP_ZONE --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
      #     
      #     # Check backend
      #     if curl -f -s "http://$VM1_IP:5080/health" > /dev/null 2>&1; then
      #       echo "‚úÖ VM-1 Backend is healthy"
      #     else
      #       echo "‚ö†Ô∏è  VM-1 Backend health check failed (may still be starting)"
      #     fi
      #     
      #     # Check frontend
      #     if curl -f -s "http://$VM1_IP:3000" > /dev/null 2>&1; then
      #       echo "‚úÖ VM-1 Frontend is healthy"
      #     else
      #       echo "‚ö†Ô∏è  VM-1 Frontend health check failed (may still be starting)"
      #     fi

      - name: Deploy to VM-2 (backup demo VM)
        run: |
          echo "üöÄ Deploying to $VM2_NAME..."
          gcloud compute ssh $VM2_NAME --zone=$GCP_ZONE --project=${{ env.GCP_PROJECT }} --command="
            set -e
            echo 'üìÇ Navigating to project directory...'
            cd /opt/aurora-demo
            
            echo 'üì• Pulling latest code from demo branch...'
            git fetch origin
            git checkout demo
            git pull origin demo
            
            echo 'üîÑ Restarting services...'
            docker compose -f docker-compose.prod-local.yml up -d --remove-orphans
            
            echo '‚úÖ VM-2 deployment complete!'
          " 2>&1

      - name: Wait for VM-2 services to stabilize
        run: |
          echo "‚è≥ Waiting 30 seconds for services to start..."
          sleep 30

      - name: Health check VM-2
        run: |
          echo "üè• Checking VM-2 health..."
          
          VM2_IP=$(gcloud compute instances describe $VM2_NAME --zone=$GCP_ZONE --project=${{ env.GCP_PROJECT }} --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          # Check backend
          if curl -f -s "http://$VM2_IP:5080/health" > /dev/null 2>&1; then
            echo "‚úÖ VM-2 Backend is healthy"
          else
            echo "‚ö†Ô∏è  VM-2 Backend health check failed (may still be starting)"
          fi
          
          # Check frontend
          if curl -f -s "http://$VM2_IP:3000" > /dev/null 2>&1; then
            echo "‚úÖ VM-2 Frontend is healthy"
          else
            echo "‚ö†Ô∏è  VM-2 Frontend health check failed (may still be starting)"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "================================================"
          echo "üéâ Deployment Summary"
          echo "================================================"
          echo ""
          echo "Branch: demo"
          echo "Commit: ${{ github.sha }}"
          echo "VMs deployed:"
          echo "  - $VM2_NAME (backup demo VM)"
          echo ""
          echo "Note: Primary VM deployment is currently disabled"
          echo ""
          
          VM2_IP=$(gcloud compute instances describe $VM2_NAME --zone=$GCP_ZONE --project=${{ env.GCP_PROJECT }} --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "Access URLs:"
          echo "  VM-2 Frontend: http://$VM2_IP:3000"
          echo "  VM-2 Backend:  http://$VM2_IP:5080"
          echo ""
          echo "View logs: make prod-local-logs"
          echo "================================================"
