# Deploy to Demo VMs - GitHub Actions Workflow
# 
# This workflow automatically deploys Aurora to demo VMs when code is pushed to the demo branch.
#
# SETUP FOR YOUR PROJECT:
#
# 1. Update the `env` section below with your GCP infrastructure details:
#    - GCP_PROJECT: Your GCP project ID
#    - WORKLOAD_IDENTITY_PROVIDER: Full path to your WIF provider
#      (Format: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID)
#    - SERVICE_ACCOUNT: Email of your deployment service account
#
# 2. Create GCP secrets for VM configuration:
#    gcloud secrets create demo-gcp-zone --data-file=- <<< "us-central1-a"
#    gcloud secrets create demo-vm1-name --data-file=- <<< "aurora-demo-vm"
#    gcloud secrets create demo-vm1-domain --data-file=- <<< "demo1.aurora-ai.net"
#    gcloud secrets create demo-vm1-frontend-url --data-file=- <<< "https://demo1.aurora-ai.net"
#    gcloud secrets create demo-vm1-backend-url --data-file=- <<< "https://demo1.aurora-ai.net"
#    gcloud secrets create demo-vm1-websocket-url --data-file=- <<< "wss://demo1.aurora-ai.net/ws"
#    gcloud secrets create demo-vm2-name --data-file=- <<< "aurora-demo-vm-2"
#    gcloud secrets create demo-vm2-domain --data-file=- <<< "demo2.aurora-ai.net"
#    gcloud secrets create demo-vm2-frontend-url --data-file=- <<< "https://demo2.aurora-ai.net"
#    gcloud secrets create demo-vm2-backend-url --data-file=- <<< "https://demo2.aurora-ai.net"
#    gcloud secrets create demo-vm2-websocket-url --data-file=- <<< "wss://demo2.aurora-ai.net/ws"
#    gcloud secrets create demo-vm3-name --data-file=- <<< "aurora-demo-vm-3"
#    gcloud secrets create demo-vm3-domain --data-file=- <<< "demo3.aurora-ai.net"
#    gcloud secrets create demo-vm3-frontend-url --data-file=- <<< "https://demo3.aurora-ai.net"
#    gcloud secrets create demo-vm3-backend-url --data-file=- <<< "https://demo3.aurora-ai.net"
#    gcloud secrets create demo-vm3-websocket-url --data-file=- <<< "wss://demo3.aurora-ai.net/ws"
#    gcloud secrets create demo-bb-oauth-client-id --data-file=- <<< "<value>"
#    gcloud secrets create demo-bb-oauth-client-secret --data-file=- <<< "<value>"
#    gcloud secrets create demo-bb-enable-bitbucket --data-file=- <<< "true"
#
# 3. Grant the service account access to these secrets:
#    for secret in demo-gcp-zone demo-vm1-name demo-vm1-domain demo-vm1-frontend-url \
#                  demo-vm1-backend-url demo-vm1-websocket-url demo-vm2-name demo-vm2-domain \
#                  demo-vm2-frontend-url demo-vm2-backend-url demo-vm2-websocket-url \
#                  demo-vm3-name demo-vm3-domain demo-vm3-frontend-url demo-vm3-backend-url \
#                  demo-vm3-websocket-url demo-bb-oauth-client-id demo-bb-oauth-client-secret \
#                  demo-bb-enable-bitbucket; do
#      gcloud secrets add-iam-policy-binding $secret \
#        --member="serviceAccount:YOUR-SERVICE-ACCOUNT" \
#        --role="roles/secretmanager.secretAccessor"
#    done
#
# 4. Ensure your VMs have:
#    - Git repository cloned to /opt/aurora-demo
#    - Docker & Docker Compose installed
#    - SSH access from GitHub Actions (via WIF service account)
#
# For full setup instructions, see: docs/deployment/demo-vm-cicd.md
#

name: Deploy to Demo VMs

on:
  push:
    branches:
      - demo
  workflow_dispatch:

# These are infrastructure values (not sensitive secrets)
env:
  GCP_PROJECT: sublime-flux-414616
  WORKLOAD_IDENTITY_PROVIDER: projects/1015371839961/locations/global/workloadIdentityPools/github-actions/providers/github
  SERVICE_ACCOUNT: aurora-demo-deployer@sublime-flux-414616.iam.gserviceaccount.com

jobs:
  deploy-vm2:
    name: Deploy to VM-2
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Load configuration from GCP Secret Manager
        run: |
          GCP_ZONE=$(gcloud secrets versions access latest --secret="demo-gcp-zone" --project="${{ env.GCP_PROJECT }}")
          VM2_NAME=$(gcloud secrets versions access latest --secret="demo-vm2-name" --project="${{ env.GCP_PROJECT }}")
          VM2_DOMAIN=$(gcloud secrets versions access latest --secret="demo-vm2-domain" --project="${{ env.GCP_PROJECT }}")
          VM2_FRONTEND_URL=$(gcloud secrets versions access latest --secret="demo-vm2-frontend-url" --project="${{ env.GCP_PROJECT }}")
          VM2_BACKEND_URL=$(gcloud secrets versions access latest --secret="demo-vm2-backend-url" --project="${{ env.GCP_PROJECT }}")
          VM2_WEBSOCKET_URL=$(gcloud secrets versions access latest --secret="demo-vm2-websocket-url" --project="${{ env.GCP_PROJECT }}")
          BB_OAUTH_CLIENT_ID=$(gcloud secrets versions access latest --secret="demo-bb-oauth-client-id" --project="${{ env.GCP_PROJECT }}")
          BB_OAUTH_CLIENT_SECRET=$(gcloud secrets versions access latest --secret="demo-bb-oauth-client-secret" --project="${{ env.GCP_PROJECT }}")
          BB_ENABLE_BITBUCKET=$(gcloud secrets versions access latest --secret="demo-bb-enable-bitbucket" --project="${{ env.GCP_PROJECT }}")
          ENABLE_DYNATRACE=$(gcloud secrets versions access latest --secret="demo-dynatrace-enable" --project="${{ env.GCP_PROJECT }}")

          echo "::add-mask::$BB_OAUTH_CLIENT_SECRET"

          echo "GCP_ZONE=$GCP_ZONE" >> $GITHUB_ENV
          echo "VM2_NAME=$VM2_NAME" >> $GITHUB_ENV
          echo "VM2_DOMAIN=$VM2_DOMAIN" >> $GITHUB_ENV
          echo "VM2_FRONTEND_URL=$VM2_FRONTEND_URL" >> $GITHUB_ENV
          echo "VM2_BACKEND_URL=$VM2_BACKEND_URL" >> $GITHUB_ENV
          echo "VM2_WEBSOCKET_URL=$VM2_WEBSOCKET_URL" >> $GITHUB_ENV
          echo "BB_OAUTH_CLIENT_ID=$BB_OAUTH_CLIENT_ID" >> $GITHUB_ENV
          echo "BB_OAUTH_CLIENT_SECRET=$BB_OAUTH_CLIENT_SECRET" >> $GITHUB_ENV
          echo "BB_ENABLE_BITBUCKET=$BB_ENABLE_BITBUCKET" >> $GITHUB_ENV
          echo "ENABLE_DYNATRACE=$ENABLE_DYNATRACE" >> $GITHUB_ENV

          echo "Configuration loaded for $VM2_NAME"

      - name: Snooze VM-2 uptime alerts
        run: |
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          END_TIME=$(date -u -d '+45 minutes' +%Y-%m-%dT%H:%M:%SZ)

          RESPONSE=$(curl -sf -X POST \
            "https://monitoring.googleapis.com/v3/projects/${{ env.GCP_PROJECT }}/snoozes" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"displayName\": \"cicd-deploy-vm2-${{ github.run_id }}\",
              \"criteria\": {
                \"policies\": [\"projects/${{ env.GCP_PROJECT }}/alertPolicies/3387004217654143013\"]
              },
              \"interval\": {
                \"startTime\": \"$START_TIME\",
                \"endTime\": \"$END_TIME\"
              }
            }")

          SNOOZE_NAME=$(echo "$RESPONSE" | jq -r '.name')
          echo "SNOOZE_NAME=$SNOOZE_NAME" >> $GITHUB_ENV
          echo "Snooze created: $SNOOZE_NAME"

      - name: Deploy to VM-2
        timeout-minutes: 30
        run: |
          gcloud compute ssh $VM2_NAME --zone=$GCP_ZONE --project=${{ env.GCP_PROJECT }} --command="
            set -e
            cd /opt/aurora-demo
            sudo chown -R \$(whoami):\$(whoami) /opt/aurora-demo
            git config --global --add safe.directory /opt/aurora-demo
            git fetch origin
            git checkout demo
            git checkout .
            git pull origin demo

            sudo sed -i 's|^DOMAIN=.*|DOMAIN=${{ env.VM2_DOMAIN }}|' .env || echo 'DOMAIN=${{ env.VM2_DOMAIN }}' | sudo tee -a .env
            sudo sed -i 's|^FRONTEND_URL=.*|FRONTEND_URL=${{ env.VM2_FRONTEND_URL }}|' .env
            sudo sed -i 's|^NEXT_PUBLIC_BACKEND_URL=.*|NEXT_PUBLIC_BACKEND_URL=${{ env.VM2_BACKEND_URL }}|' .env
            sudo sed -i 's|^NEXT_PUBLIC_WEBSOCKET_URL=.*|NEXT_PUBLIC_WEBSOCKET_URL=${{ env.VM2_WEBSOCKET_URL }}|' .env
            sudo sed -i 's|^NEXT_PUBLIC_ENABLE_BITBUCKET=.*|NEXT_PUBLIC_ENABLE_BITBUCKET=${{ env.BB_ENABLE_BITBUCKET }}|' .env || echo 'NEXT_PUBLIC_ENABLE_BITBUCKET=${{ env.BB_ENABLE_BITBUCKET }}' | sudo tee -a .env
            sudo sed -i 's|^BB_OAUTH_CLIENT_ID=.*|BB_OAUTH_CLIENT_ID=${{ env.BB_OAUTH_CLIENT_ID }}|' .env || echo 'BB_OAUTH_CLIENT_ID=${{ env.BB_OAUTH_CLIENT_ID }}' | sudo tee -a .env
            sudo sed -i 's|^BB_OAUTH_CLIENT_SECRET=.*|BB_OAUTH_CLIENT_SECRET=${{ env.BB_OAUTH_CLIENT_SECRET }}|' .env || echo 'BB_OAUTH_CLIENT_SECRET=${{ env.BB_OAUTH_CLIENT_SECRET }}' | sudo tee -a .env
            sudo sed -i 's|^NEXT_PUBLIC_ENABLE_DYNATRACE=.*|NEXT_PUBLIC_ENABLE_DYNATRACE=${{ env.ENABLE_DYNATRACE }}|' .env || echo 'NEXT_PUBLIC_ENABLE_DYNATRACE=${{ env.ENABLE_DYNATRACE }}' | sudo tee -a .env

            sudo docker compose -f docker-compose.prod-local.yml build frontend aurora-server
            sudo docker compose -f docker-compose.prod-local.yml up -d --remove-orphans
            sudo docker compose -f docker-compose.prod-local.yml up -d --force-recreate demo-init
          " 2>&1

      - name: Health check VM-2
        run: |
          echo "Waiting 30 seconds for services to start..."
          sleep 30
          if curl -f -s -k "https://${{ env.VM2_DOMAIN }}" > /dev/null 2>&1; then
            echo "VM-2 is responding"
          else
            echo "VM-2 health check failed (may still be starting)"
          fi

      - name: Unsnooze VM-2 uptime alerts
        if: always()
        run: |
          if [ -z "$SNOOZE_NAME" ] || [ "$SNOOZE_NAME" = "null" ]; then
            echo "No snooze to remove"
            exit 0
          fi

          ACCESS_TOKEN=$(gcloud auth print-access-token)
          START_TIME=$(curl -sf "https://monitoring.googleapis.com/v3/$SNOOZE_NAME" \
            -H "Authorization: Bearer $ACCESS_TOKEN" | jq -r '.interval.startTime')
          NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          curl -sf -X PATCH \
            "https://monitoring.googleapis.com/v3/$SNOOZE_NAME?updateMask=interval" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"interval\": {
                \"startTime\": \"$START_TIME\",
                \"endTime\": \"$NOW\"
              }
            }"

          echo "Snooze cancelled: $SNOOZE_NAME"

  deploy-vm3:
    name: Deploy to VM-3
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Load configuration from GCP Secret Manager
        run: |
          GCP_ZONE=$(gcloud secrets versions access latest --secret="demo-gcp-zone" --project="${{ env.GCP_PROJECT }}")
          VM3_NAME=$(gcloud secrets versions access latest --secret="demo-vm3-name" --project="${{ env.GCP_PROJECT }}")
          VM3_DOMAIN=$(gcloud secrets versions access latest --secret="demo-vm3-domain" --project="${{ env.GCP_PROJECT }}")
          VM3_FRONTEND_URL=$(gcloud secrets versions access latest --secret="demo-vm3-frontend-url" --project="${{ env.GCP_PROJECT }}")
          VM3_BACKEND_URL=$(gcloud secrets versions access latest --secret="demo-vm3-backend-url" --project="${{ env.GCP_PROJECT }}")
          VM3_WEBSOCKET_URL=$(gcloud secrets versions access latest --secret="demo-vm3-websocket-url" --project="${{ env.GCP_PROJECT }}")
          BB_OAUTH_CLIENT_ID=$(gcloud secrets versions access latest --secret="demo-bb-oauth-client-id" --project="${{ env.GCP_PROJECT }}")
          BB_OAUTH_CLIENT_SECRET=$(gcloud secrets versions access latest --secret="demo-bb-oauth-client-secret" --project="${{ env.GCP_PROJECT }}")
          BB_ENABLE_BITBUCKET=$(gcloud secrets versions access latest --secret="demo-bb-enable-bitbucket" --project="${{ env.GCP_PROJECT }}")
          ENABLE_DYNATRACE=$(gcloud secrets versions access latest --secret="demo-dynatrace-enable" --project="${{ env.GCP_PROJECT }}")

          echo "::add-mask::$BB_OAUTH_CLIENT_SECRET"

          echo "GCP_ZONE=$GCP_ZONE" >> $GITHUB_ENV
          echo "VM3_NAME=$VM3_NAME" >> $GITHUB_ENV
          echo "VM3_DOMAIN=$VM3_DOMAIN" >> $GITHUB_ENV
          echo "VM3_FRONTEND_URL=$VM3_FRONTEND_URL" >> $GITHUB_ENV
          echo "VM3_BACKEND_URL=$VM3_BACKEND_URL" >> $GITHUB_ENV
          echo "VM3_WEBSOCKET_URL=$VM3_WEBSOCKET_URL" >> $GITHUB_ENV
          echo "BB_OAUTH_CLIENT_ID=$BB_OAUTH_CLIENT_ID" >> $GITHUB_ENV
          echo "BB_OAUTH_CLIENT_SECRET=$BB_OAUTH_CLIENT_SECRET" >> $GITHUB_ENV
          echo "BB_ENABLE_BITBUCKET=$BB_ENABLE_BITBUCKET" >> $GITHUB_ENV
          echo "ENABLE_DYNATRACE=$ENABLE_DYNATRACE" >> $GITHUB_ENV

          echo "Configuration loaded for $VM3_NAME"

      - name: Snooze VM-3 uptime alerts
        run: |
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          END_TIME=$(date -u -d '+45 minutes' +%Y-%m-%dT%H:%M:%SZ)

          RESPONSE=$(curl -sf -X POST \
            "https://monitoring.googleapis.com/v3/projects/${{ env.GCP_PROJECT }}/snoozes" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"displayName\": \"cicd-deploy-vm3-${{ github.run_id }}\",
              \"criteria\": {
                \"policies\": [\"projects/${{ env.GCP_PROJECT }}/alertPolicies/8353618263584682505\"]
              },
              \"interval\": {
                \"startTime\": \"$START_TIME\",
                \"endTime\": \"$END_TIME\"
              }
            }")

          SNOOZE_NAME=$(echo "$RESPONSE" | jq -r '.name')
          echo "SNOOZE_NAME=$SNOOZE_NAME" >> $GITHUB_ENV
          echo "Snooze created: $SNOOZE_NAME"

      - name: Deploy to VM-3
        timeout-minutes: 30
        run: |
          gcloud compute ssh $VM3_NAME --zone=$GCP_ZONE --project=${{ env.GCP_PROJECT }} --command="
            set -e
            cd /opt/aurora-demo
            sudo chown -R \$(whoami):\$(whoami) /opt/aurora-demo
            git config --global --add safe.directory /opt/aurora-demo
            git fetch origin
            git checkout demo
            git checkout .
            git pull origin demo

            sudo sed -i 's|^DOMAIN=.*|DOMAIN=${{ env.VM3_DOMAIN }}|' .env || echo 'DOMAIN=${{ env.VM3_DOMAIN }}' | sudo tee -a .env
            sudo sed -i 's|^FRONTEND_URL=.*|FRONTEND_URL=${{ env.VM3_FRONTEND_URL }}|' .env
            sudo sed -i 's|^NEXT_PUBLIC_BACKEND_URL=.*|NEXT_PUBLIC_BACKEND_URL=${{ env.VM3_BACKEND_URL }}|' .env
            sudo sed -i 's|^NEXT_PUBLIC_WEBSOCKET_URL=.*|NEXT_PUBLIC_WEBSOCKET_URL=${{ env.VM3_WEBSOCKET_URL }}|' .env
            sudo sed -i 's|^NEXT_PUBLIC_ENABLE_BITBUCKET=.*|NEXT_PUBLIC_ENABLE_BITBUCKET=${{ env.BB_ENABLE_BITBUCKET }}|' .env || echo 'NEXT_PUBLIC_ENABLE_BITBUCKET=${{ env.BB_ENABLE_BITBUCKET }}' | sudo tee -a .env
            sudo sed -i 's|^BB_OAUTH_CLIENT_ID=.*|BB_OAUTH_CLIENT_ID=${{ env.BB_OAUTH_CLIENT_ID }}|' .env || echo 'BB_OAUTH_CLIENT_ID=${{ env.BB_OAUTH_CLIENT_ID }}' | sudo tee -a .env
            sudo sed -i 's|^BB_OAUTH_CLIENT_SECRET=.*|BB_OAUTH_CLIENT_SECRET=${{ env.BB_OAUTH_CLIENT_SECRET }}|' .env || echo 'BB_OAUTH_CLIENT_SECRET=${{ env.BB_OAUTH_CLIENT_SECRET }}' | sudo tee -a .env
            sudo sed -i 's|^NEXT_PUBLIC_ENABLE_DYNATRACE=.*|NEXT_PUBLIC_ENABLE_DYNATRACE=${{ env.ENABLE_DYNATRACE }}|' .env || echo 'NEXT_PUBLIC_ENABLE_DYNATRACE=${{ env.ENABLE_DYNATRACE }}' | sudo tee -a .env

            sudo docker compose -f docker-compose.prod-local.yml build frontend aurora-server
            sudo docker compose -f docker-compose.prod-local.yml up -d --remove-orphans
            sudo docker compose -f docker-compose.prod-local.yml up -d --force-recreate demo-init
          " 2>&1

      - name: Health check VM-3
        run: |
          echo "Waiting 30 seconds for services to start..."
          sleep 30
          if curl -f -s -k "https://${{ env.VM3_DOMAIN }}" > /dev/null 2>&1; then
            echo "VM-3 is responding"
          else
            echo "VM-3 health check failed (may still be starting)"
          fi

      - name: Unsnooze VM-3 uptime alerts
        if: always()
        run: |
          if [ -z "$SNOOZE_NAME" ] || [ "$SNOOZE_NAME" = "null" ]; then
            echo "No snooze to remove"
            exit 0
          fi

          ACCESS_TOKEN=$(gcloud auth print-access-token)
          START_TIME=$(curl -sf "https://monitoring.googleapis.com/v3/$SNOOZE_NAME" \
            -H "Authorization: Bearer $ACCESS_TOKEN" | jq -r '.interval.startTime')
          NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          curl -sf -X PATCH \
            "https://monitoring.googleapis.com/v3/$SNOOZE_NAME?updateMask=interval" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"interval\": {
                \"startTime\": \"$START_TIME\",
                \"endTime\": \"$NOW\"
              }
            }"

          echo "Snooze cancelled: $SNOOZE_NAME"

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-vm2, deploy-vm3]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "================================================"
          echo "Deployment Summary"
          echo "================================================"
          echo "Branch: demo"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "VM-2: ${{ needs.deploy-vm2.result }}"
          echo "VM-3: ${{ needs.deploy-vm3.result }}"
          echo "================================================"
