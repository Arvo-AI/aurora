{{- if .Values.services.vault.enabled }}
# NetworkPolicy to restrict Vault access to only trusted Aurora pods.
# This prevents untrusted terminal pods (or any other workloads) from
# connecting to Vault and potentially intercepting tokens or secrets.
#
# Allowed pods: server, chatbot, celery-worker, celery-beat
# Denied: terminal pods in untrusted namespace, any other workloads
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "aurora.fullname" . }}-vault-access
  labels:
    {{- include "aurora.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ include "aurora.name" . }}-vault
      app.kubernetes.io/instance: {{ .Release.Name }}
  policyTypes:
    - Ingress
  ingress:
    # Allow access from Aurora server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: {{ include "aurora.name" . }}-server
              app.kubernetes.io/instance: {{ .Release.Name }}
      ports:
        - protocol: TCP
          port: 8200
    # Allow access from Aurora chatbot
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: {{ include "aurora.name" . }}-chatbot
              app.kubernetes.io/instance: {{ .Release.Name }}
      ports:
        - protocol: TCP
          port: 8200
    # Allow access from Celery worker
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: {{ include "aurora.name" . }}-celery-worker
              app.kubernetes.io/instance: {{ .Release.Name }}
      ports:
        - protocol: TCP
          port: 8200
    # Allow access from Celery beat
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: {{ include "aurora.name" . }}-celery-beat
              app.kubernetes.io/instance: {{ .Release.Name }}
      ports:
        - protocol: TCP
          port: 8200
{{- end }}
